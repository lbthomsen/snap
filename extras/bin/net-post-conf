#!/bin/bash

ovs-vsctl --may-exist add-br lxc-br
ovs-vsctl --may-exist add-port lxc-br nat -- set interface nat type=internal
ifconfig nat 10.10.10.254/24

iptables -t nat -A POSTROUTING -j MASQUERADE
iptables -A POSTROUTING -t mangle -p udp --dport bootpc -j CHECKSUM --checksum-fill

ifup -a --allow=env

if [ -f "$SNAP_DATA/.ip" ]; then
	while true; do
		echo $(subutai info ipaddr) | nc $(cat "$SNAP_DATA/.ip") 48723
		if [ "$(echo $?)" == "0" ]; then
			rm -f "$SNAP_DATA/.ip"
		fi

		sleep 4
	done
fi 
